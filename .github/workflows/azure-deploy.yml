name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: matchnord
  NODE_VERSION: "20"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: matchnord-extranet/package-lock.json

      - name: Install dependencies
        working-directory: matchnord-extranet
        run: npm ci

      - name: Generate Prisma client
        working-directory: matchnord-extranet
        run: npm run prisma:generate

      - name: Validate required secrets
        run: |
          [ -n "${{ secrets.DATABASE_URL }}" ] || { echo "❌ Error: DATABASE_URL secret is not set"; exit 1; }
          [ -n "${{ secrets.NEXTAUTH_SECRET }}" ] || { echo "❌ Error: NEXTAUTH_SECRET secret is not set"; exit 1; }
          [ -n "${{ secrets.NEXTAUTH_URL }}" ] || { echo "❌ Error: NEXTAUTH_URL secret is not set"; exit 1; }
          # Check publish profile by reading it into a variable with proper quoting
          PUBLISH_PROFILE=$(echo "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}")
          [ -n "$PUBLISH_PROFILE" ] || { echo "❌ Error: AZURE_WEBAPP_PUBLISH_PROFILE secret is not set"; exit 1; }
          echo "✅ All required secrets are set"

      - name: Build application
        working-directory: matchnord-extranet
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: npm run build

      - name: Create deployment package
        working-directory: matchnord-extranet
        run: |
          mkdir -p deploy-package
          # Copy standalone output (contains server.js and node_modules)
          cp -r .next/standalone/* deploy-package/
          # Ensure .next directory exists and copy necessary files
          mkdir -p deploy-package/.next
          cp -r .next/static deploy-package/.next/static
          # Copy entire server directory from source (overwrites standalone's .next/server if it exists)
          # This ensures we have the complete server directory with all manifest files
          rm -rf deploy-package/.next/server
          cp -r .next/server deploy-package/.next/server
          # Copy all manifest files required by Next.js standalone
          cp .next/BUILD_ID deploy-package/.next/BUILD_ID 2>/dev/null || echo "BUILD_ID not found"
          cp .next/routes-manifest.json deploy-package/.next/routes-manifest.json 2>/dev/null || echo "routes-manifest.json not found"
          cp .next/prerender-manifest.json deploy-package/.next/prerender-manifest.json 2>/dev/null || echo "prerender-manifest.json not found"
          cp .next/prerender-manifest.js deploy-package/.next/prerender-manifest.js 2>/dev/null || echo "prerender-manifest.js not found"
          cp .next/images-manifest.json deploy-package/.next/images-manifest.json 2>/dev/null || echo "images-manifest.json not found"
          cp .next/build-manifest.json deploy-package/.next/build-manifest.json 2>/dev/null || echo "build-manifest.json not found"
          cp .next/app-build-manifest.json deploy-package/.next/app-build-manifest.json 2>/dev/null || echo "app-build-manifest.json not found"
          cp .next/react-loadable-manifest.json deploy-package/.next/react-loadable-manifest.json 2>/dev/null || echo "react-loadable-manifest.json not found"
          # Copy public folder if it exists
          [ -d "public" ] && cp -r public deploy-package/ || echo "No public directory found, skipping"
          # Copy Prisma files for migrations
          cp -r prisma deploy-package/
          # Copy package.json and update start script for standalone
          cp package.json deploy-package/
          # Update start script to use node server.js for standalone output
          node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('deploy-package/package.json')); pkg.scripts.start='node server.js'; fs.writeFileSync('deploy-package/package.json', JSON.stringify(pkg, null, 2));"
          cp package-lock.json deploy-package/ 2>/dev/null || true
          # Verify server.js exists
          if [ ! -f "deploy-package/server.js" ]; then
            echo "❌ Error: server.js not found in deploy-package"
            exit 1
          fi
          # Verify BUILD_ID exists
          if [ ! -f "deploy-package/.next/BUILD_ID" ]; then
            echo "⚠️ Warning: BUILD_ID not found, but continuing..."
          fi
          # Verify pages-manifest.json exists
          if [ ! -f "deploy-package/.next/server/pages-manifest.json" ]; then
            echo "❌ Error: pages-manifest.json not found in deploy-package/.next/server/"
            exit 1
          fi
          echo "✅ Verified pages-manifest.json exists"
          # Create zip file for deployment
          cd deploy-package
          zip -r ../deploy-package.zip . -x "*.DS_Store"
          cd ..
          echo "✅ Deployment package created successfully"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: matchnord-extranet/deploy-package.zip
          type: zip
          restart: true

      - name: Run database migrations and seed
        working-directory: matchnord-extranet
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npx prisma migrate deploy || echo "No migrations to run"
          npm run prisma:seed || echo "Seed completed or skipped"
