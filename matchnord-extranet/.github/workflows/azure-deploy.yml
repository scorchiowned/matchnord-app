name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: matchnord
  RESOURCE_GROUP: matchnord-rg
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma generate

      - name: Build application
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: npm run build

      - name: Verify standalone build
        run: |
          if [ ! -d ".next/standalone" ]; then
            echo "âŒ Standalone build not found!"
            exit 1
          fi
          echo "âœ… Standalone build created successfully"

      - name: Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          rm -rf deploy-temp
          mkdir -p deploy-temp

          # Copy standalone files (excluding node_modules - we'll install Linux-compatible ones)
          echo "ðŸ“‹ Copying standalone files..."
          cd .next/standalone

          # Copy all files except node_modules (this includes .next directory from standalone)
          for item in * .[!.]*; do
            if [ -e "$item" ] && [ "$item" != "node_modules" ]; then
              echo "   Copying: $item"
              cp -r "$item" ../deploy-temp/
            fi
          done
          cd ../..

          # The standalone build includes .next directory with required-server-files.json
          # But we also need to ensure static files are copied from the root .next directory
          echo "ðŸ“‹ Ensuring complete .next directory structure..."

          # Ensure .next directory exists
          if [ ! -d "deploy-temp/.next" ]; then
            echo "âš ï¸  .next directory not found in standalone, creating from root..."
            mkdir -p deploy-temp/.next
          fi

          # Copy required-server-files.json from standalone's .next (should already be there, but ensure it)
          if [ -f ".next/standalone/.next/required-server-files.json" ]; then
            cp .next/standalone/.next/required-server-files.json deploy-temp/.next/required-server-files.json
            echo "âœ… Copied required-server-files.json from standalone"
          elif [ -f ".next/required-server-files.json" ]; then
            cp .next/required-server-files.json deploy-temp/.next/required-server-files.json
            echo "âœ… Copied required-server-files.json from root .next"
          fi

          # Copy static files from root .next (standalone might have a minimal version)
          if [ -d ".next/static" ]; then
            mkdir -p deploy-temp/.next
            cp -r .next/static deploy-temp/.next/static
            echo "âœ… Copied .next/static"
          fi

          # Ensure server directory is complete
          if [ -d ".next/server" ] && [ ! -d "deploy-temp/.next/server" ]; then
            mkdir -p deploy-temp/.next
            cp -r .next/server deploy-temp/.next/server
            echo "âœ… Copied .next/server"
          fi

          # Verify required-server-files.json exists
          if [ ! -f "deploy-temp/.next/required-server-files.json" ]; then
            echo "âŒ ERROR: required-server-files.json not found in deployment package!"
            echo "   Checking what's in deploy-temp/.next:"
            ls -la deploy-temp/.next/ 2>/dev/null || echo "   .next directory doesn't exist"
            echo "   Checking standalone .next:"
            ls -la .next/standalone/.next/ 2>/dev/null || echo "   standalone .next doesn't exist"
            echo "   Checking root .next:"
            ls -la .next/ 2>/dev/null | grep -E "(required|json)" || echo "   root .next doesn't have it"
            exit 1
          else
            echo "âœ… Verified: required-server-files.json exists at deploy-temp/.next/required-server-files.json"
          fi

          # Copy package files
          cp package.json deploy-temp/
          cp package-lock.json deploy-temp/ 2>/dev/null || true

          # Copy Prisma schema
          cp -r prisma deploy-temp/

          # Copy public folder
          [ -d public ] && cp -r public deploy-temp/ || echo "âš ï¸  public directory not found"

          # Copy middleware if it exists
          [ -f middleware.ts ] && cp middleware.ts deploy-temp/ || true

          # Verify server.js exists (required for standalone build)
          if [ ! -f "deploy-temp/server.js" ]; then
            echo "âŒ ERROR: server.js not found in deployment package!"
            exit 1
          fi
          echo "âœ… Verified: server.js exists in deployment package"

          echo "âœ… Files copied to deployment package"

      - name: Install production dependencies
        working-directory: deploy-temp
        run: |
          echo "ðŸ“¦ Installing production dependencies with Linux-compatible binaries..."

          # Verify .next directory exists before npm install (npm might clean it)
          if [ ! -f ".next/required-server-files.json" ]; then
            echo "âŒ ERROR: required-server-files.json missing before npm install!"
            exit 1
          fi

          npm ci --production --ignore-scripts || npm install --production --ignore-scripts

          # Verify .next directory still exists after npm install
          if [ ! -f ".next/required-server-files.json" ]; then
            echo "âŒ ERROR: required-server-files.json missing after npm install!"
            echo "   npm install may have removed it. Restoring..."
            # Try to restore from source if available
            if [ -f "../../.next/required-server-files.json" ]; then
              cp ../../.next/required-server-files.json .next/required-server-files.json
              echo "âœ… Restored required-server-files.json"
            else
              exit 1
            fi
          fi

          echo "ðŸ”§ Generating Prisma Client with Linux-compatible binaries..."
          if [ -f "node_modules/.bin/prisma" ]; then
            DATABASE_URL="${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}" \
            ./node_modules/.bin/prisma generate || echo "âš ï¸  Prisma generate had issues, but continuing..."
          fi

          echo "âœ… Production dependencies installed"
          echo "âœ… Verified: required-server-files.json still exists after npm install"

      - name: Create .env.production
        working-directory: deploy-temp
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: |
          cat > .env.production << EOF
          DATABASE_URL="${DATABASE_URL}"
          NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
          NEXTAUTH_URL="${NEXTAUTH_URL}"
          AZURE_STORAGE_ACCOUNT_NAME="${AZURE_STORAGE_ACCOUNT_NAME}"
          AZURE_STORAGE_ACCOUNT_KEY="${AZURE_STORAGE_ACCOUNT_KEY}"
          AZURE_STORAGE_CONTAINER_NAME="${AZURE_STORAGE_CONTAINER_NAME}"
          NODE_ENV=production
          EOF

      - name: Verify server.js and .next directory in package
        run: |
          if [ ! -f "deploy-temp/server.js" ]; then
            echo "âŒ ERROR: server.js not found in deploy-temp!"
            exit 1
          fi
          echo "âœ… Verified: server.js exists"
          ls -la deploy-temp/server.js

          # Verify .next directory structure
          echo ""
          echo "ðŸ“‹ Checking .next directory structure:"
          if [ -d "deploy-temp/.next" ]; then
            echo "âœ… .next directory exists"
            ls -la deploy-temp/.next/ | head -20
            if [ -f "deploy-temp/.next/required-server-files.json" ]; then
              echo "âœ… required-server-files.json found"
            else
              echo "âŒ ERROR: required-server-files.json NOT found in deploy-temp/.next/"
              echo "   Contents of deploy-temp/.next/:"
              find deploy-temp/.next -type f | head -20
              exit 1
            fi
          else
            echo "âŒ ERROR: .next directory not found!"
            exit 1
          fi

      - name: Create deployment zip
        run: |
          cd deploy-temp
          zip -r ../deploy-package.zip . -x "*.DS_Store"
          cd ..
          echo "ðŸ“¦ Deployment package created: deploy-package.zip"
          echo "ðŸ“Š Package size: $(du -h deploy-package.zip | cut -f1)"

          # Verify critical files are in the zip
          if unzip -l deploy-package.zip | grep -q "server.js"; then
            echo "âœ… Verified: server.js is included in deployment zip"
          else
            echo "âŒ ERROR: server.js not found in deployment zip!"
            exit 1
          fi

          if unzip -l deploy-package.zip | grep -q "required-server-files.json"; then
            echo "âœ… Verified: required-server-files.json is included in deployment zip"
          else
            echo "âŒ ERROR: required-server-files.json not found in deployment zip!"
            echo "   Listing .next files in zip:"
            unzip -l deploy-package.zip | grep "\.next" | head -20
            exit 1
          fi

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package.zip

      - name: Configure Azure App Settings
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}

      - name: Set Azure environment variables and startup command
        uses: azure/CLI@v2
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        with:
          inlineScript: |
            # Set environment variables
            az webapp config appsettings set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" \
              NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
              AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
              NODE_ENV=production \
              --output none

            # Set startup command to directly run server.js
            az webapp config set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --startup-file "node server.js" \
              --output none

            echo "âœ… Startup command set to: node server.js"

      - name: Warning about startup command
        if: ${{ secrets.AZURE_CREDENTIALS == '' }}
        run: |
          echo "âš ï¸  WARNING: AZURE_CREDENTIALS not set, startup command not configured automatically"
          echo "   Please set the startup command manually in Azure Portal:"
          echo "   1. Go to Azure Portal â†’ Your Web App â†’ Configuration â†’ General settings"
          echo "   2. Set 'Startup Command' to: node server.js"
          echo "   Or set AZURE_CREDENTIALS secret to configure automatically"

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ”„ Running database migrations before deployment..."
          cd deploy-temp
          if [ -f "node_modules/.bin/prisma" ]; then
            ./node_modules/.bin/prisma migrate deploy || {
              echo "âš ï¸  Migration had issues, but continuing deployment"
              echo "   Migrations should be run manually if needed"
            }
          else
            echo "âŒ Prisma CLI not found, cannot run migrations"
            exit 1
          fi
          echo "âœ… Migrations completed"

      - name: Cleanup
        if: always()
        run: |
          rm -rf deploy-temp
          rm -f deploy-package.zip
