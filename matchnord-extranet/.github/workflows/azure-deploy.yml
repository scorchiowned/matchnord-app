name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: matchnord
  RESOURCE_GROUP: matchnord-rg
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: ./matchnord-extranet

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './matchnord-extranet/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma generate

      - name: Build application
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: npm run build

      - name: Verify standalone build
        run: |
          if [ ! -d ".next/standalone" ]; then
            echo "‚ùå Standalone build not found!"
            exit 1
          fi
          echo "‚úÖ Standalone build created successfully"

      - name: Prepare standalone deployment package
        working-directory: ./matchnord-extranet
        run: |
          echo "üì¶ Preparing standalone deployment package..."

          # Move static files into standalone (matching working example pattern)
          echo "üìã Moving .next/static into standalone..."
          if [ -d ".next/static" ]; then
            # Ensure .next directory exists in standalone
            mkdir -p .next/standalone/.next
            cp -r .next/static .next/standalone/.next/static
            echo "‚úÖ Copied .next/static to standalone/.next/static"
          fi

          # Move public folder into standalone (matching working example pattern)
          echo "üìã Moving public folder into standalone..."
          if [ -d "public" ]; then
            cp -r public .next/standalone/public
            echo "‚úÖ Copied public to standalone/public"
          fi

          # Ensure required-server-files.json is in standalone/.next
          echo "üìã Ensuring required-server-files.json is present..."
          if [ -f ".next/required-server-files.json" ]; then
            mkdir -p .next/standalone/.next
            cp .next/required-server-files.json .next/standalone/.next/required-server-files.json
            echo "‚úÖ Copied required-server-files.json to standalone/.next/"
          fi

          # Copy Prisma schema for migrations
          if [ -d "prisma" ]; then
            cp -r prisma .next/standalone/prisma
            echo "‚úÖ Copied prisma schema"
          fi

          # Verify critical files exist
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "‚ùå ERROR: server.js not found in standalone!"
            exit 1
          fi

          if [ ! -f ".next/standalone/.next/required-server-files.json" ]; then
            echo "‚ùå ERROR: required-server-files.json not found in standalone/.next/"
            ls -la .next/standalone/.next/ 2>/dev/null || echo "   .next directory doesn't exist in standalone"
            exit 1
          fi

          echo "‚úÖ Standalone package prepared successfully"
          echo "   Structure:"
          ls -la .next/standalone/ | head -10

      - name: Install production dependencies in standalone
        working-directory: ./matchnord-extranet/.next/standalone
        run: |
          echo "üì¶ Installing production dependencies with Linux-compatible binaries..."

          # Remove existing node_modules if present (from build)
          rm -rf node_modules

          # Install production dependencies
          npm ci --production --ignore-scripts || npm install --production --ignore-scripts

          echo "üîß Generating Prisma Client with Linux-compatible binaries..."
          if [ -f "node_modules/.bin/prisma" ]; then
            DATABASE_URL="${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}" \
            ./node_modules/.bin/prisma generate || echo "‚ö†Ô∏è  Prisma generate had issues, but continuing..."
          fi

          echo "‚úÖ Production dependencies installed"

      - name: Create .env.production
        working-directory: ./matchnord-extranet/.next/standalone
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: |
          cat > .env.production << EOF
          DATABASE_URL="${DATABASE_URL}"
          NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
          NEXTAUTH_URL="${NEXTAUTH_URL}"
          AZURE_STORAGE_ACCOUNT_NAME="${AZURE_STORAGE_ACCOUNT_NAME}"
          AZURE_STORAGE_ACCOUNT_KEY="${AZURE_STORAGE_ACCOUNT_KEY}"
          AZURE_STORAGE_CONTAINER_NAME="${AZURE_STORAGE_CONTAINER_NAME}"
          NODE_ENV=production
          EOF

      - name: Verify deployment package
        working-directory: ./matchnord-extranet
        run: |
          echo "üìã Verifying deployment package structure..."
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "‚ùå ERROR: server.js not found!"
            exit 1
          fi
          if [ ! -f ".next/standalone/.next/required-server-files.json" ]; then
            echo "‚ùå ERROR: required-server-files.json not found!"
            ls -la .next/standalone/.next/ 2>/dev/null || echo "   .next directory doesn't exist"
            exit 1
          fi
          if [ ! -d ".next/standalone/.next/static" ]; then
            echo "‚ùå ERROR: .next/static not found!"
            exit 1
          fi
          echo "‚úÖ All critical files verified"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./matchnord-extranet/.next/standalone

      - name: Configure Azure App Settings
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}

      - name: Set Azure environment variables and startup command
        uses: azure/CLI@v2
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        with:
          inlineScript: |
            # Set environment variables
            az webapp config appsettings set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" \
              NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
              AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
              NODE_ENV=production \
              --output none

            # Set startup command to directly run server.js
            az webapp config set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --startup-file "node server.js" \
              --output none

            echo "‚úÖ Startup command set to: node server.js"

      - name: Warning about startup command
        if: ${{ secrets.AZURE_CREDENTIALS == '' }}
        run: |
          echo "‚ö†Ô∏è  WARNING: AZURE_CREDENTIALS not set, startup command not configured automatically"
          echo "   Please set the startup command manually in Azure Portal:"
          echo "   1. Go to Azure Portal ‚Üí Your Web App ‚Üí Configuration ‚Üí General settings"
          echo "   2. Set 'Startup Command' to: node server.js"
          echo "   Or set AZURE_CREDENTIALS secret to configure automatically"

      - name: Run database migrations
        working-directory: ./matchnord-extranet/.next/standalone
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîÑ Running database migrations before deployment..."
          if [ -f "node_modules/.bin/prisma" ]; then
            ./node_modules/.bin/prisma migrate deploy || {
              echo "‚ö†Ô∏è  Migration had issues, but continuing deployment"
              echo "   Migrations should be run manually if needed"
            }
          else
            echo "‚ùå Prisma CLI not found, cannot run migrations"
            exit 1
          fi
          echo "‚úÖ Migrations completed"
