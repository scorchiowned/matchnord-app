name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: matchnord
  RESOURCE_GROUP: matchnord-rg
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma generate

      - name: Build application
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: npm run build

      - name: Verify standalone build
        run: |
          if [ ! -d ".next/standalone" ]; then
            echo "âŒ Standalone build not found!"
            exit 1
          fi
          echo "âœ… Standalone build created successfully"

      - name: Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          rm -rf deploy-temp
          mkdir -p deploy-temp

          # Copy standalone files (excluding node_modules - we'll install Linux-compatible ones)
          echo "ðŸ“‹ Copying standalone files..."
          cd .next/standalone

          # Copy all files except node_modules
          for item in * .[!.]*; do
            if [ -e "$item" ] && [ "$item" != "node_modules" ]; then
              cp -r "$item" ../deploy-temp/
            fi
          done
          cd ../..

          # Copy the complete .next directory structure from build output
          # This includes required-server-files.json and all necessary files
          echo "ðŸ“‹ Copying .next directory structure..."
          if [ -d ".next" ]; then
            mkdir -p deploy-temp/.next
            
            # Copy required-server-files.json (critical for Next.js standalone)
            if [ -f ".next/required-server-files.json" ]; then
              cp .next/required-server-files.json deploy-temp/.next/
              echo "âœ… Copied required-server-files.json"
            fi
            
            # Copy static files (if not already copied from standalone)
            if [ -d ".next/static" ]; then
              cp -r .next/static deploy-temp/.next/static
              echo "âœ… Copied .next/static"
            fi
            
            # Copy server directory (if not already copied from standalone)
            if [ -d ".next/server" ]; then
              cp -r .next/server deploy-temp/.next/server
              echo "âœ… Copied .next/server"
            fi
            
            # Copy any other .next files that might be needed
            for file in .next/*.json .next/*.js .next/*.txt 2>/dev/null; do
              if [ -f "$file" ]; then
                cp "$file" deploy-temp/.next/
              fi
            done
          fi

          # Verify required-server-files.json exists
          if [ ! -f "deploy-temp/.next/required-server-files.json" ]; then
            echo "âŒ ERROR: required-server-files.json not found in deployment package!"
            echo "   Listing .next directory contents:"
            ls -la deploy-temp/.next/ 2>/dev/null || echo "   .next directory doesn't exist"
            exit 1
          else
            echo "âœ… Verified: required-server-files.json exists"
          fi

          # Copy package files
          cp package.json deploy-temp/
          cp package-lock.json deploy-temp/ 2>/dev/null || true

          # Copy Prisma schema
          cp -r prisma deploy-temp/

          # Copy public folder
          [ -d public ] && cp -r public deploy-temp/ || echo "âš ï¸  public directory not found"

          # Copy middleware if it exists
          [ -f middleware.ts ] && cp middleware.ts deploy-temp/ || true

          # Verify server.js exists (required for standalone build)
          if [ ! -f "deploy-temp/server.js" ]; then
            echo "âŒ ERROR: server.js not found in deployment package!"
            exit 1
          fi
          echo "âœ… Verified: server.js exists in deployment package"

          echo "âœ… Files copied to deployment package"

      - name: Install production dependencies
        working-directory: deploy-temp
        run: |
          echo "ðŸ“¦ Installing production dependencies with Linux-compatible binaries..."
          npm ci --production --ignore-scripts || npm install --production --ignore-scripts

          echo "ðŸ”§ Generating Prisma Client with Linux-compatible binaries..."
          if [ -f "node_modules/.bin/prisma" ]; then
            DATABASE_URL="${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}" \
            ./node_modules/.bin/prisma generate || echo "âš ï¸  Prisma generate had issues, but continuing..."
          fi

          echo "âœ… Production dependencies installed"

      - name: Create .env.production
        working-directory: deploy-temp
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: |
          cat > .env.production << EOF
          DATABASE_URL="${DATABASE_URL}"
          NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
          NEXTAUTH_URL="${NEXTAUTH_URL}"
          AZURE_STORAGE_ACCOUNT_NAME="${AZURE_STORAGE_ACCOUNT_NAME}"
          AZURE_STORAGE_ACCOUNT_KEY="${AZURE_STORAGE_ACCOUNT_KEY}"
          AZURE_STORAGE_CONTAINER_NAME="${AZURE_STORAGE_CONTAINER_NAME}"
          NODE_ENV=production
          EOF

      - name: Verify server.js in package
        run: |
          if [ ! -f "deploy-temp/server.js" ]; then
            echo "âŒ ERROR: server.js not found in deploy-temp!"
            exit 1
          fi
          echo "âœ… Verified: server.js exists"
          ls -la deploy-temp/server.js

      - name: Create deployment zip
        run: |
          cd deploy-temp
          zip -r ../deploy-package.zip . -x "*.DS_Store"
          cd ..
          echo "ðŸ“¦ Deployment package created: deploy-package.zip"
          echo "ðŸ“Š Package size: $(du -h deploy-package.zip | cut -f1)"

          # Verify server.js is in the zip
          if unzip -l deploy-package.zip | grep -q "server.js"; then
            echo "âœ… Verified: server.js is included in deployment zip"
          else
            echo "âŒ ERROR: server.js not found in deployment zip!"
            exit 1
          fi

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package.zip

      - name: Configure Azure App Settings
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}

      - name: Set Azure environment variables and startup command
        uses: azure/CLI@v2
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        with:
          inlineScript: |
            # Set environment variables
            az webapp config appsettings set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" \
              NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
              AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
              NODE_ENV=production \
              --output none

            # Set startup command to directly run server.js
            az webapp config set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --startup-file "node server.js" \
              --output none

            echo "âœ… Startup command set to: node server.js"

      - name: Warning about startup command
        if: ${{ secrets.AZURE_CREDENTIALS == '' }}
        run: |
          echo "âš ï¸  WARNING: AZURE_CREDENTIALS not set, startup command not configured automatically"
          echo "   Please set the startup command manually in Azure Portal:"
          echo "   1. Go to Azure Portal â†’ Your Web App â†’ Configuration â†’ General settings"
          echo "   2. Set 'Startup Command' to: node server.js"
          echo "   Or set AZURE_CREDENTIALS secret to configure automatically"

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ”„ Running database migrations before deployment..."
          cd deploy-temp
          if [ -f "node_modules/.bin/prisma" ]; then
            ./node_modules/.bin/prisma migrate deploy || {
              echo "âš ï¸  Migration had issues, but continuing deployment"
              echo "   Migrations should be run manually if needed"
            }
          else
            echo "âŒ Prisma CLI not found, cannot run migrations"
            exit 1
          fi
          echo "âœ… Migrations completed"

      - name: Cleanup
        if: always()
        run: |
          rm -rf deploy-temp
          rm -f deploy-package.zip
