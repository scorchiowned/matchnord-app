name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: matchnord
  RESOURCE_GROUP: matchnord-rg
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: ./matchnord-extranet

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './matchnord-extranet/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma generate

      - name: Build application
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: npm run build

      - name: Verify standalone build
        run: |
          if [ ! -d ".next/standalone" ]; then
            echo "‚ùå Standalone build not found!"
            exit 1
          fi
          echo "‚úÖ Standalone build created successfully"

      - name: Prepare standalone deployment package
        working-directory: ./matchnord-extranet
        run: |
          echo "üì¶ Preparing standalone deployment package..."

          # The standalone build already has .next directory with server files
          # We need to ensure static files and required-server-files.json are present

          # Check what's already in standalone/.next
          echo "üìã Checking standalone/.next structure..."
          if [ -d ".next/standalone/.next" ]; then
            echo "‚úÖ Found .next directory in standalone"
            ls -la .next/standalone/.next/ | head -10
          else
            echo "‚ö†Ô∏è  .next directory not found in standalone, creating..."
            mkdir -p .next/standalone/.next
          fi

          # Copy static files into standalone/.next (matching working example pattern)
          echo "üìã Copying .next/static into standalone/.next..."
          if [ -d ".next/static" ]; then
            cp -r .next/static .next/standalone/.next/static
            echo "‚úÖ Copied .next/static to standalone/.next/static"
          fi

          # Ensure required-server-files.json is in standalone/.next (CRITICAL)
          echo "üìã Ensuring required-server-files.json is present..."
          if [ -f ".next/required-server-files.json" ]; then
            cp .next/required-server-files.json .next/standalone/.next/required-server-files.json
            echo "‚úÖ Copied required-server-files.json to standalone/.next/"
            # Verify it was copied
            if [ -f ".next/standalone/.next/required-server-files.json" ]; then
              echo "‚úÖ Verified: required-server-files.json exists"
              ls -la .next/standalone/.next/required-server-files.json
            else
              echo "‚ùå ERROR: Copy failed!"
              exit 1
            fi
          else
            echo "‚ùå ERROR: required-server-files.json not found in source .next/"
            exit 1
          fi

          # Copy public folder into standalone (matching working example pattern)
          echo "üìã Copying public folder into standalone..."
          if [ -d "public" ]; then
            cp -r public .next/standalone/public
            echo "‚úÖ Copied public to standalone/public"
          fi

          # Copy Prisma schema for migrations
          if [ -d "prisma" ]; then
            cp -r prisma .next/standalone/prisma
            echo "‚úÖ Copied prisma schema"
          fi

          # Verify critical files exist
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "‚ùå ERROR: server.js not found in standalone!"
            exit 1
          fi

          if [ ! -f ".next/standalone/.next/required-server-files.json" ]; then
            echo "‚ùå ERROR: required-server-files.json not found in standalone/.next/"
            echo "   Contents of standalone/.next/:"
            ls -la .next/standalone/.next/ 2>/dev/null || echo "   .next directory doesn't exist"
            exit 1
          fi

          echo "‚úÖ Standalone package prepared successfully"
          echo "   Structure:"
          ls -la .next/standalone/ | head -10
          echo "   .next structure:"
          ls -la .next/standalone/.next/ | head -10

      - name: Install production dependencies in standalone
        working-directory: ./matchnord-extranet/.next/standalone
        run: |
          echo "üì¶ Installing production dependencies with Linux-compatible binaries..."

          # CRITICAL: Verify .next directory exists before npm install
          if [ ! -d ".next" ]; then
            echo "‚ùå ERROR: .next directory missing before npm install!"
            exit 1
          fi

          if [ ! -f ".next/required-server-files.json" ]; then
            echo "‚ùå ERROR: required-server-files.json missing before npm install!"
            exit 1
          fi

          echo "‚úÖ Verified: .next directory and required-server-files.json exist before npm install"

          # Remove existing node_modules if present (from build)
          rm -rf node_modules

          # Install production dependencies (this should NOT touch .next directory)
          npm ci --production --ignore-scripts || npm install --production --ignore-scripts

          # CRITICAL: Verify .next directory still exists after npm install
          if [ ! -f ".next/required-server-files.json" ]; then
            echo "‚ùå ERROR: required-server-files.json missing after npm install!"
            echo "   Restoring from source..."
            if [ -f "../../.next/required-server-files.json" ]; then
              mkdir -p .next
              cp ../../.next/required-server-files.json .next/required-server-files.json
              echo "‚úÖ Restored required-server-files.json"
            else
              echo "‚ùå Cannot restore - source file not found"
              exit 1
            fi
          fi

          # Ensure .next/static still exists
          if [ ! -d ".next/static" ]; then
            echo "‚ö†Ô∏è  .next/static missing after npm install, restoring..."
            if [ -d "../../.next/static" ]; then
              cp -r ../../.next/static .next/static
              echo "‚úÖ Restored .next/static"
            fi
          fi

          echo "üîß Generating Prisma Client with Linux-compatible binaries..."
          if [ -f "node_modules/.bin/prisma" ]; then
            DATABASE_URL="${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}" \
            ./node_modules/.bin/prisma generate || echo "‚ö†Ô∏è  Prisma generate had issues, but continuing..."
          fi

          echo "‚úÖ Production dependencies installed"
          echo "‚úÖ Verified: required-server-files.json still exists after npm install"

          # Ensure file permissions are correct (readable by all)
          chmod 644 .next/required-server-files.json
          chmod 755 .next

          # Verify it's not a symlink and is readable
          if [ -L ".next/required-server-files.json" ]; then
            echo "‚ö†Ô∏è  WARNING: required-server-files.json is a symlink, converting to regular file..."
            cp .next/required-server-files.json .next/required-server-files.json.tmp
            rm .next/required-server-files.json
            mv .next/required-server-files.json.tmp .next/required-server-files.json
          fi

          # Final verification
          ls -la .next/required-server-files.json
          file .next/required-server-files.json
          test -r .next/required-server-files.json && echo "‚úÖ File is readable" || echo "‚ùå File is NOT readable"

      - name: Create .env.production
        working-directory: ./matchnord-extranet/.next/standalone
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
          AZURE_STORAGE_CONTAINER_NAME: ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}
        run: |
          cat > .env.production << EOF
          DATABASE_URL="${DATABASE_URL}"
          NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
          NEXTAUTH_URL="${NEXTAUTH_URL}"
          AZURE_STORAGE_ACCOUNT_NAME="${AZURE_STORAGE_ACCOUNT_NAME}"
          AZURE_STORAGE_ACCOUNT_KEY="${AZURE_STORAGE_ACCOUNT_KEY}"
          AZURE_STORAGE_CONTAINER_NAME="${AZURE_STORAGE_CONTAINER_NAME}"
          NODE_ENV=production
          EOF

      - name: Verify deployment package
        working-directory: ./matchnord-extranet
        run: |
          echo "üìã Verifying deployment package structure..."
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "‚ùå ERROR: server.js not found!"
            exit 1
          fi

          # Verify .next directory structure
          if [ ! -d ".next/standalone/.next" ]; then
            echo "‚ùå ERROR: .next directory not found in standalone!"
            exit 1
          fi

          if [ ! -f ".next/standalone/.next/required-server-files.json" ]; then
            echo "‚ùå ERROR: required-server-files.json not found!"
            echo "   Contents of standalone/.next/:"
            ls -la .next/standalone/.next/ 2>/dev/null || echo "   .next directory doesn't exist"
            echo "   Looking for required-server-files.json:"
            find .next/standalone -name "required-server-files.json" || echo "   Not found anywhere"
            exit 1
          fi

          # Verify file permissions and ensure it's a regular file (not symlink)
          if [ ! -r ".next/standalone/.next/required-server-files.json" ]; then
            echo "‚ö†Ô∏è  WARNING: required-server-files.json exists but is not readable!"
            ls -la .next/standalone/.next/required-server-files.json
            chmod 644 .next/standalone/.next/required-server-files.json
            echo "‚úÖ Fixed permissions"
          fi

          # Ensure it's not a symlink
          if [ -L ".next/standalone/.next/required-server-files.json" ]; then
            echo "‚ö†Ô∏è  WARNING: required-server-files.json is a symlink, converting to regular file..."
            cp .next/standalone/.next/required-server-files.json .next/standalone/.next/required-server-files.json.tmp
            rm .next/standalone/.next/required-server-files.json
            mv .next/standalone/.next/required-server-files.json.tmp .next/standalone/.next/required-server-files.json
            chmod 644 .next/standalone/.next/required-server-files.json
            echo "‚úÖ Converted symlink to regular file"
          fi

          # Ensure .next directory is readable
          chmod 755 .next/standalone/.next

          # Final verification
          echo "   File details:"
          ls -la .next/standalone/.next/required-server-files.json
          file .next/standalone/.next/required-server-files.json
          test -r .next/standalone/.next/required-server-files.json && echo "‚úÖ File is readable" || echo "‚ùå File is NOT readable"

          if [ ! -d ".next/standalone/.next/static" ]; then
            echo "‚ùå ERROR: .next/static not found!"
            exit 1
          fi

          echo "‚úÖ All critical files verified"
          echo "   File structure:"
          tree .next/standalone/.next -L 2 2>/dev/null || find .next/standalone/.next -maxdepth 2 -type f | head -10

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./matchnord-extranet/.next/standalone

      - name: Configure Azure App Settings
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}

      - name: Set Azure environment variables and startup command
        uses: azure/CLI@v2
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        with:
          inlineScript: |
            # Set environment variables
            az webapp config appsettings set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" \
              NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
              AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
              NODE_ENV=production \
              --output none

            # Set startup command to directly run server.js
            az webapp config set \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --startup-file "node server.js" \
              --output none

            echo "‚úÖ Startup command set to: node server.js"

      - name: Warning about startup command
        if: ${{ secrets.AZURE_CREDENTIALS == '' }}
        run: |
          echo "‚ö†Ô∏è  WARNING: AZURE_CREDENTIALS not set, startup command not configured automatically"
          echo "   Please set the startup command manually in Azure Portal:"
          echo "   1. Go to Azure Portal ‚Üí Your Web App ‚Üí Configuration ‚Üí General settings"
          echo "   2. Set 'Startup Command' to: node server.js"
          echo "   Or set AZURE_CREDENTIALS secret to configure automatically"

      - name: Run database migrations
        working-directory: ./matchnord-extranet/.next/standalone
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîÑ Running database migrations before deployment..."
          if [ -f "node_modules/.bin/prisma" ]; then
            ./node_modules/.bin/prisma migrate deploy || {
              echo "‚ö†Ô∏è  Migration had issues, but continuing deployment"
              echo "   Migrations should be run manually if needed"
            }
          else
            echo "‚ùå Prisma CLI not found, cannot run migrations"
            exit 1
          fi
          echo "‚úÖ Migrations completed"
